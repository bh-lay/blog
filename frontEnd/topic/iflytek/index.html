<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
    <title>[Áæ§ËÅä]ËÆØÈ£ûÂ§ßÂÆ∂Â∫≠</title>
    <link rel="stylesheet" href="style.less">
</head>
<body>
<div id="app">
    <div class="chat-window" ref="chat-window">  
      <div class="chat-list" ref="chat-list" :style="{transform: 'translateY(' + -scrollTop + 'px)'}">
        <div v-for="chatItem in chatList" class="chat-item">
            <div :class="[chatItem.from === 'me' ? 'chat-item-me' : 'chat-item-other']">
                <span class="avatar" :style="{backgroundImage: 'url(' + user[chatItem.from].avatar + ')'}"></span>
                <div class="content">
                    <div class="nickname">{{user[chatItem.from].nickname}}</div>
                    <div class="content-body">
                      <div v-if="chatItem.text" class="text">{{chatItem.text}}</div>
                      <div v-else class="image" :style="{backgroundImage: 'url(' + chatItem.image + ')'}">
                        <div :style="{paddingTop: chatItem.sizePercent * 100 + '%'}"></div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
  <div class="input-bar">
    <div class="typed-area">{{typedText}}</div>
  </div>
</div>
<script src="vue.js" type="text/javascript"></script>
<script type="text/javascript">
  var chatList = [
    {
      from: 'a',
      text: 'Êñ∞‰∫∫Âø´Ëá™Êàë‰ªãÁªç'
    },
    {
      from: 'me',
      text: 'Â§ßÂÆ∂Â•ΩÔºåÊàëÊòØÂâß‰∏≠‰∫∫ÔºåÂú®Â§ßÊï∞ÊçÆÂÜôÈ°µÈù¢ÁöÑ'
    },
    {
      from: 'me',
      text: 'ÂâçÂá†Â§©‰∏Ä‰∏çÂ∞èÂøÉÂà∑‰∫ÜÂ§ßÂÆ∂ÊúãÂèãÂúàÁöÑ„Äå‰∏≠ÂõΩÂ£∞Ë∞∑ÁúãÈõ™ÊôØ„ÄçÊòØÊàëÁöÑ‰ΩúÂìÅ'
    },
    {
      from: 'b',
      text: 'ÂéüÊù•ÊòØ‰Ω†ÂïäÔºåÂπ∏‰ºöÂπ∏‰ºö'
    },
    {
      from: 'c',
      text: '‰ΩúÂìÅÊå∫ÁæéÁöÑÔºåËµûüëç'
    },
    {
      from: 'a',
      text: 'ËøõÁæ§ÊúâÂï•‰∫ãÔºü'
    },
    {
      from: 'me',
      text: 'ÊúÄËøëÂÖ¨Âè∏‰∏çÊòØÊêû‰∫Ü‰∏™‚ÄúÂÖâÂΩ±ÈöèÂøÉ‚ÄùÊëÑÂΩ±ÊØîËµõ‰πàÔºåÊàë‰πüÊä•ÂêçÂèÇÂä†‰∫Ü'
    },
    {
      from: 'b',
      text: 'ÊáÇ‰∫ÜÔºå‰Ω†ÊòØÊù•ÊâæÊàë‰ª¨Âà∑Á•®ÁöÑ'
    },
    {
      from: 'c',
      // text: 'ÂÖàÂà´Âä®ÔºåÁúãÁúã‰ªñÊé•‰∏ãÊù•ËØ¥‰ªÄ‰πà',
      image: __uri('chat-image/despacito.png'),
      sizePercent: 1
    },
    {
      from: 'me',
      text: 'Âà∑Á•®ÂèØ‰∏çÊï¢Ôºå‰ºöË¢´ÂÖ¨Âè∏ÂºÄÈô§ÁöÑ'
    },
    {
      from: 'me',
      text: 'Â∞±ÊòØÊ¥ªÂä®Â§™ËøáÁÉ≠ÈóπÔºå‰ΩúÂìÅÂ§öÂà∞ÁàÜÔºåÊÉ≥ËÆ©Â§ßÂÆ∂ÊäΩÁ©∫Áúã‰∏Ä‰∏ãÊàëÁöÑ‰ΩúÂìÅ\nËßâÂæó‰∏çÈîôÁöÑËØùÈ∫ªÁÉ¶ÊäïÊàë‰∏ÄÁ•®'
    },
    {
      from: 'b',
      text: 'ËøòËØ¥‰∏çÊòØÂà∑Á•®ÁöÑ'
    },
    {
      from: 'c',
      // text: 'Â∞±ÊòØÂ∞±ÊòØ'
      image: __uri('chat-image/yes.jpg'),
      sizePercent: 1
    },
    {
      from: 'a',
      text: 'ÁúãÊù•‰Ω†Êå∫Áî®ÂøÉÁöÑÔºåËØ¥ÂêßË¶ÅÊÄé‰πàÊäïÁ•®Ôºü'
    },
    {
      from: 'me',
      text: 'Â§öË∞¢Âï¶ÔºåÊàëÁöÑ‰ΩúÂìÅ‰∏ÄÂÖ±Êúâ‰∏§‰ªΩ,‰∏Ä‰ªΩÊòØ„Äå‰∏≠ÂõΩÂ£∞Ë∞∑ÁúãÈõ™ÊôØ„ÄçÂêåÂêç‰ΩúÂìÅÔºåÂè¶‰∏Ä‰ªΩÊòØ„ÄåÊóÖË°åÈöèÊãç„ÄçÔºåÂ∞ÅÈù¢ÂõæÊòØ'
    },
    {
      from: 'me',
      image: __uri('chat-image/screenshot.jpg'),
      sizePercent: .5
    },
    {
      from: 'me',
      text: 'ÊäïÁ•®Â∞±ÊòØÁÇπËµûÂï¶ÔºåÊØè‰∏™‰∫∫ÊúâÂçÅ‰∏™ÁÇπËµûÁöÑÊú∫‰ºöÔºåÂâ©‰ΩôÁöÑËµûÂèØ‰ª•ÊîØÊåÅ‰∏ãÂÖ∂‰ªñÂ∞è‰ºô‰º¥ÁöÑ‰ΩúÂìÅÂë¶„ÄÇ'
    },
    {
      from: 'c',
      text: 'Ê¥ªÂä®Âú∞ÂùÄÂú®Âì™ÂÑøÂë¢Ôºü'
    },
    {
      from: 'me',
      text: 'Âì¶ÔºåÂøò‰∫ÜÂèë‰∫ÜÔºåÂèØ‰ª•ÁÇπËøô‰∏™ÈìæÊé•ÔºåÂ∞±ÂèØ‰ª•ËøõÂÖ•ÊäïÁ•®È°µÈù¢Âï¶ÔºÅ'
    },
  ];
  var user = {
      me: {
        nickname: 'Ââß‰∏≠‰∫∫ÔºàÊñ∞ÊàêÂëòÔºâ',
        avatar: __uri('avatar/avatar-lay.jpg')
      },
      a: {
        nickname: 'ÊµÖÂ∞ùËæÑÊ≠¢ÔºàÁæ§‰∏ªÔºâ',
        avatar: __uri('avatar/a.jpg')
      },
      b: {
        nickname: 'Ê†ë‰∏äÁöÑÈ™∑È´ÖÔºàÁãóÁÆ°ÁêÜÔºâ',
        avatar: __uri('avatar/b.jpeg')
      },
      c: {
        nickname: '‰∏ÄÈ°µÔºàËêåÊñ∞ÊãÖÂΩìÔºâ',
        avatar: __uri('avatar/c.jpg')
      }
  };
  function typed(text, stepCallback, onEnd){
    var sliceLength = 0;
    function step(){
      sliceLength++;
      stepCallback(text.slice(0, sliceLength))
      if (sliceLength >= text.length) {
        setTimeout(onEnd, 700)
      } else{
        setTimeout(step, 160)
      }
    }
    setTimeout(step, 1000)
  }
  new Vue({
    el: '#app',
    data: {
      scrollTop: 0,
      typedText: '',
      user: user,
      chatList: []
    },
    mounted: function () {
      var me = this;
      function chatItem(){
        if(chatList.length){
          // typed
          let newItem = chatList.shift();
          function sendMsg(){
            me.chatList.push(newItem);
            me.scrollToEnd();
            // ËøõÂÖ•‰∏ã‰∏ÄÊ¨°ËÅäÂ§©
            chatItem()
          }
          if(newItem.from === 'me' && !!newItem.text) {
            typed(newItem.text, function(text){
              me.typedText = text;
            }, function () {
              me.typedText = '';
              sendMsg();
            })
          } else {
            setTimeout(sendMsg, 1500);
          }
        } else {
          me.setNormalScroll()
        }
      }
      chatItem();
    },
    methods: {
      scrollToEnd: function () {
        var nodeOuter = this.$refs['chat-window'];
        var nodeInner = this.$refs['chat-list'];
        this.$nextTick(function(){
          this.scrollTop = Math.max(nodeInner.clientHeight - nodeOuter.clientHeight, 0);
        });
      },
      setNormalScroll: function () {
        var nodeOuter = this.$refs['chat-window'];
        var nodeInner = this.$refs['chat-list'];
        setTimeout(function(){
          nodeOuter.classList.add('normal-scroll')
          nodeOuter.scrollTop = nodeInner.clientHeight - nodeOuter.clientHeight;
        }, 500);
      }
    }
  })
</script>
</body>
</html>