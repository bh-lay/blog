<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
    <title>[ç¾¤èŠ]è®¯é£å¤§å®¶åº­</title>
    <link rel="stylesheet" href="style.less">
</head>
<body>
<div id="app">
    <div class="chat-window" ref="chat-window">  
      <div class="chat-list" ref="chat-list" :style="{transform: 'translateY(' + -scrollTop + 'px)'}">
        <div v-for="chatItem in chatList" class="chat-item">
          <div v-if="chatItem.from === 'system'" class="system-msg">
            <div class="msg">{{chatItem.text}}</div>
          </div>
            <div v-else :class="[chatItem.from === 'me' ? 'chat-item-me' : 'chat-item-other']">
                <span class="avatar" :style="{backgroundImage: 'url(' + user[chatItem.from].avatar + ')'}"></span>
                <div class="content">
                    <div class="nickname">{{user[chatItem.from].nickname}}</div>
                    <div class="content-body">
                      <div v-if="chatItem.text" class="text">{{chatItem.text}}<a :href="chatItem.link" v-if="chatItem.link">@ç«™å¤–é“¾æ¥</a></div>
                      <div v-else class="image" :style="{backgroundImage: 'url(' + chatItem.image + ')'}">
                        <div :style="{paddingTop: chatItem.sizePercent * 100 + '%'}"></div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
  <div class="footer">
      <div class="input-bar">
        <div class="typed-area">{{typedText}}</div>
      </div>
      <div class="sound-input">
          <div class="sound-wave">
              <span class="line1"></span>
              <span class="line2"></span>
              <span class="line3"></span>
              <span class="line4"></span>
          </div>
          <div class="mask" :class="[isTyping ? 'hidden' : '']">è®¯é£è¯­éŸ³è¾“å…¥æ³•</div>
      </div>
  </div>
</div>
<div class="loading-mask">
  <div class="text"><p>æ­£åœ¨åŠ å…¥ç¾¤èŠ</p><h3>è®¯é£å¤§å®¶åº­</h3></div>
</div>
<script src="vue.js" type="text/javascript"></script>
<script type="text/javascript">
  var chatList = [
    {
      from: 'system',
      text: '[å‰§ä¸­äºº]å·²åŠ å…¥ç¾¤èŠ'
    },
    {
      from: 'a',
      text: 'æ–°äººå¿«è‡ªæˆ‘ä»‹ç»'
    },
    {
      from: 'me',
      text: 'å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å‰§ä¸­äººï¼Œå¤§æ•°æ®ç ”ç©¶é™¢å†™ä»£ç çš„'
    },
    {
      from: 'me',
      text: 'å‰å‡ å¤©ä¸€ä¸å°å¿ƒåœ¨å¤§å®¶æœ‹å‹åœˆåˆ·å±çš„ã€Œä¸­å›½å£°è°·çœ‹é›ªæ™¯ã€ä¹Ÿæ˜¯æˆ‘çš„ä½œå“'
    },
    {
      from: 'b',
      text: 'åŸæ¥æ˜¯ä½ æ‹çš„å•Šï¼Œå¹¸ä¼šå¹¸ä¼š'
    },
    {
      from: 'c',
      text: 'ä½œå“æŒºç¾çš„ï¼Œèµ ğŸ‘'
    },
    {
      from: 'a',
      text: 'è¿›ç¾¤æœ‰å•¥äº‹ï¼Ÿ'
    },
    {
      from: 'me',
      text: 'æœ€è¿‘å…¬å¸ä¸æ˜¯æäº†ä¸ªâ€œå…‰å½±éšå¿ƒâ€æ‘„å½±æ¯”èµ›ä¹ˆï¼Œæˆ‘ä¹ŸæŠ¥åå‚åŠ äº†'
    },
    {
      from: 'b',
      text: 'æ‡‚äº†ï¼Œä½ æ˜¯æ¥æ‰¾æˆ‘ä»¬åˆ·ç¥¨çš„'
    },
    {
      from: 'c',
      // text: 'å…ˆåˆ«åŠ¨ï¼Œçœ‹çœ‹ä»–æ¥ä¸‹æ¥è¯´ä»€ä¹ˆ',
      image: __uri('chat-image/despacito.png'),
      sizePercent: 1
    },
    {
      from: 'me',
      text: 'åˆ·ç¥¨å¯ä¸æ•¢ï¼Œä¼šè¢«å…¬å¸å¼€é™¤çš„'
    },
    {
      from: 'me',
      text: 'å°±æ˜¯æ´»åŠ¨å¤ªè¿‡çƒ­é—¹ï¼Œä½œå“å¤šåˆ°çˆ†ï¼Œæƒ³è®©å¤§å®¶æŠ½ç©ºçœ‹ä¸€ä¸‹æˆ‘çš„ä½œå“\nè§‰å¾—ä¸é”™çš„è¯éº»çƒ¦æŠ•æˆ‘ä¸€ç¥¨'
    },
    {
      from: 'b',
      text: 'è¿˜è¯´ä¸æ˜¯åˆ·ç¥¨çš„'
    },
    {
      from: 'c',
      // text: 'å°±æ˜¯å°±æ˜¯'
      image: __uri('chat-image/yes.jpg'),
      sizePercent: 1
    },
    {
      from: 'a',
      text: 'çœ‹æ¥ä½ æŒºç”¨å¿ƒçš„ï¼Œè¯´å§è¦æ€ä¹ˆæŠ•ç¥¨ï¼Ÿ'
    },
    {
      from: 'me',
      text: 'å¤šè°¢å•¦ï¼Œæˆ‘çš„ä½œå“ä¸€å…±æœ‰ä¸¤ä»½,ä¸€ä»½æ˜¯ã€Œä¸­å›½å£°è°·çœ‹é›ªæ™¯ã€åŒåä½œå“ï¼Œå¦ä¸€ä»½æ˜¯ã€Œæ—…è¡Œéšæ‹ã€'
    },
    {
      from: 'me',
      image: __uri('chat-image/screenshot.jpg'),
      sizePercent: .5
    },
    {
      from: 'me',
      text: 'æŠ•ç¥¨å°±æ˜¯ç‚¹èµå•¦ï¼Œæ¯ä¸ªäººæœ‰åä¸ªç‚¹èµçš„æœºä¼šï¼Œå‰©ä½™çš„èµå¯ä»¥æ”¯æŒä¸‹å…¶ä»–å°ä¼™ä¼´çš„ä½œå“å‘¦'
    },
    {
      from: 'c',
      text: 'æ´»åŠ¨åœ°å€åœ¨å“ªå„¿å‘¢ï¼Ÿ'
    },
    {
      from: 'me',
      text: 'å“¦ï¼Œå¿˜å‘äº†ï¼Œè¿™ä¸ªé“¾æ¥é‡Œæœ‰è¿›å…¥æŠ•ç¥¨é¡µé¢æ–¹å¼ï¼'
    },
    {
      from: 'me',
      text: 'å¤šè°¢å¤§ä¼™å„¿äº†',
      link: 'http://xxx.xxx.xxx/'
    },
    {
      from: 'a',
      text: '6666666666'
    }
  ];
  var user = {
      me: {
        nickname: 'å‰§ä¸­äººï¼ˆæ–°æˆå‘˜ï¼‰',
        avatar: __uri('avatar/avatar-lay.jpg')
      },
      a: {
        nickname: 'æµ…å°è¾„æ­¢ï¼ˆç¾¤ä¸»ï¼‰',
        avatar: __uri('avatar/a.jpg')
      },
      b: {
        nickname: 'æ ‘ä¸Šçš„éª·é«…ï¼ˆç‹—ç®¡ç†ï¼‰',
        avatar: __uri('avatar/b.jpeg')
      },
      c: {
        nickname: 'ä¸€é¡µï¼ˆèŒæ–°æ‹…å½“ï¼‰',
        avatar: __uri('avatar/c.jpg')
      }
  };
  function typed(text, stepCallback, onEnd){
    var sliceLength = 0;
    function step(){
      sliceLength++;
      stepCallback(text.slice(0, sliceLength))
      if (sliceLength >= text.length) {
        setTimeout(onEnd, 700)
      } else{
        setTimeout(step, 160)
      }
    }
    setTimeout(step, 1000)
  }

  var app = new Vue({
    el: '#app',
    data: {
      scrollTop: 0,
      typedText: '',
      isForbiddenOverflow: true,
      // æ˜¯å¦æ­£åœ¨è¾“å…¥
      isTyping: false,
      user: user,
      chatList: [
        {
          from: 'a',
          text: 'æœ‰æ–°äººåŠ ç¾¤äº†ï¼Œæˆ‘å»å¤„ç†ä¸€ä¸‹'
        },
        {
          from: 'c',
          text: 'å¿«æ‹‰è¿›æ¥çœ‹çœ‹ï¼'
        }
      ]
    },
    methods: {
      scrollToEnd: function () {
        var nodeOuter = this.$refs['chat-window'];
        var nodeInner = this.$refs['chat-list'];
        this.$nextTick(function(){
          this.scrollTop = Math.max(nodeInner.clientHeight - nodeOuter.clientHeight, 0);
        });
      },
      setNormalScroll: function () {
        var nodeOuter = this.$refs['chat-window'];
        var nodeInner = this.$refs['chat-list'];
        setTimeout(function(){
          nodeOuter.classList.add('normal-scroll')
          nodeOuter.scrollTop = nodeInner.clientHeight - nodeOuter.clientHeight;
        }, 500);
      },
      startChat: function () {
        var me = this;
        function chatItem(){
          if(chatList.length){
            // typed
            let newItem = chatList.shift();
            function sendMsg(){
              me.chatList.push(newItem);
              me.scrollToEnd();
              // è¿›å…¥ä¸‹ä¸€æ¬¡èŠå¤©
              chatItem()
            }
            if(newItem.from === 'me' && !!newItem.text) {
              typed(newItem.text, function(text){
                me.typedText = text;
                me.isTyping = true;
              }, function () {
                me.typedText = '';
                me.isTyping = false;
                sendMsg();
              })
            } else {
              setTimeout(sendMsg, 1500);
            }
          } else {
            me.isForbiddenOverflow = false;
            me.setNormalScroll()
          }
        }
        chatItem();
      }
    }
  });

  var mask = document.querySelector('.loading-mask');
  setTimeout(function(){
    mask.classList.add('close');
    setTimeout(function(){
      mask.parentNode.removeChild(mask);
      app.startChat();
    }, 500);
  }, 1000);
  // forbidden wechat scroll
  var overscroll = function(el) {
  el.addEventListener('touchstart', function() {
    var top = el.scrollTop
      , totalScroll = el.scrollHeight
      , currentScroll = top + el.offsetHeight;
    //If we're at the top or the bottom of the containers
    //scroll, push up or down one pixel.
    //
    //this prevents the scroll from "passing through" to
    //the body.
    if(top === 0) {
      el.scrollTop = 1;
    } else if(currentScroll === totalScroll) {
      el.scrollTop = top - 1;
    }
  });
  el.addEventListener('touchmove', function(evt) {
    //if the content is actually scrollable, i.e. the content is long enough
    //that scrolling can occur
    if(el.offsetHeight < el.scrollHeight)
      evt._isScroller = true;
  });
}
overscroll(document.querySelector('.chat-window'));
document.body.addEventListener('touchmove', function(evt) {
  //In this case, the default behavior is scrolling the body, which
  //would result in an overflow.  Since we don't want that, we preventDefault.
  if(!evt._isScroller || app.isForbiddenOverflow) {
    evt.preventDefault();
  }
});
</script>
</body>
</html>